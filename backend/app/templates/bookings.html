{% extends "base.html" %}

{% block content %}
<style>
    .container {
        background-color: #232323;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        max-width: 800px; /* Limit the maximum width */
    }
    .form-container {
        max-width: 600px; /* Make the form smaller */
        margin: 0 auto; /* Center the form */
    }
    .form-control, .form-select {
        background-color: #232323;
        color: #ffffff;
        border: 2px solid #4A4A4A;
        border-radius: 4px;
    }


    /* Input field focus color */
    .form-control:focus, .form-select:focus {
    background-color: #232323;
    border-color: #DC6000;
    box-shadow: 0 0 0 0.25rem rgba(220, 96, 0, 0.25);
    color: #ffffff;
    }

    .btn-primary {
        background-color: #DC6000;
        border: none;
    }
    .btn-primary:hover {
        background-color: #af4d01;
    }
    .booking-grid-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
    }
    .booking-grid {
        min-width: 100%;
        border-collapse: separate;
        border-spacing: 2px;
    }
    .booking-grid th, .booking-grid td {
        padding: 10px;
        text-align: center;
        white-space: nowrap;
        
    }
    .booking-grid th {
        background-color: #4A4A4A;
        color: white;
    }

    
    .booking-link {
        display: block;
        width: 100%;
        height: 100%;
        color: inherit;
        text-decoration: none;
        margin: 1px 0;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .booking-link:hover, .booking-link:focus {
        background-color: #DC6000;
        color:inherit;
    }
    .booking-link.booked {
        background-color: #DC6000;
        border-radius: 20px;
    }
    .booking-cell.booked {
        background-color: #DC6000;
        border-radius: 10px;
    }

    .booking-cell.open {
        background-color: transparent;
    }

    .booking-link.active {
    background-color: #DC6000;
    }
    .booking-user {
        font-size: 0.8em;
    }
    .date-range-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        align-items: flex-end;
        margin-bottom: 20px;
    }

    .date-range-form > div {
        flex: 1 1 200px;
    }
    .date-range-form label {
        margin-bottom: 5px;
    }

        /* Custom scrollbar */
        .booking-grid-container::-webkit-scrollbar {
        height: 8px;
    }
    .booking-grid-container::-webkit-scrollbar-thumb {
        background-color: #DC6000;
        border-radius: 4px;
    }
    .booking-grid-container::-webkit-scrollbar-track {
        background-color: #3a3a3a;
    }





  
    /* Scrollbar styling FOR WHOLE PAGE*/
    ::-webkit-scrollbar {
    width: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #232323;
    }
    ::-webkit-scrollbar-thumb {
        background: #DC6000;
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #af4d01;
    }

    input[type="date"] {
        background-color: #232323;
        color-scheme: dark;
    }

  
  

    /* Button alignment fix */
    .button-group {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

</style>





<div class="container mt-5">
    <div class="form-container">
        <h2 class="text-center">Book a Slot</h2>
        <form method="post" action="/book" id="bookingForm">
            <input type="hidden" name="booking_id" id="booking_id">
            <input type="hidden" name="start_date" value="{{ start_date.isoformat() }}">
            <input type="hidden" name="end_date" value="{{ end_date.isoformat() }}">
            <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name" maxlength="25" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone</label>
                <input type="text" class="form-control" id="phone" name="phone" required>
            </div>
            <div class="mb-3">
                <label for="booking_date" class="form-label">Date</label>
                <input type="date" class="form-control" id="booking_date" name="booking_date" required>
            </div>
            <div class="mb-3">
                <label for="time_slot" class="form-label">Time Slot</label>
                <select class="form-select" id="time_slot" name="time_slot" required>
                    {% for slot in time_slots %}
                        <option value="{{ slot }}">{{ slot }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="text-center">
                <button type="submit" class="btn btn-primary mt-3" id="bookButton">Book</button>
                <button type="button" class="btn btn-secondary mt-3" id="clearButton" style="display:none;">Clear Booking</button>
            </div>
        </form>
    </div>
</div>

{% if messages %}
<div class="mt-3">
    {% for message in messages %}
    <div class="alert alert-info alert-info-white">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<div class="container">
    <h2 class="text-center">Booking Grid</h2>
    <form id="dateRangeForm" class="date-range-form" method="get" action="/bookings">
        <div>
            <label for="start_date">Start Date:</label>
            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.isoformat() }}">
        </div>
        <div>
            <label for="end_date">End Date:</label>
            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.isoformat() }}">
        </div>
        <button type="submit" class="btn btn-primary">Update Range</button>
    </form>

    <div class="booking-grid-container">
        <table class="booking-grid">
            <thead>
                <tr>
                    <th>Time Slot</th>
                    {% for booking_date in date_range %}
                    <th>{{ booking_date.strftime('%a') }}<br>{{ booking_date.strftime('%Y-%m-%d') }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for time_slot in time_slots %}
                <tr>
                    <td>{{ time_slot }}</td>
                    {% for booking_date in date_range %}
                    <td class="booking-cell" data-date="{{ booking_date.isoformat() }}" data-time-slot="{{ time_slot }}">
                        <a href="#" class="booking-link">
                            <span class="booking-status">Open</span>
                            <span class="booking-user"></span>
                        </a>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let bookingsData = {
        {% for booking in bookings %}
            "{{ booking.booking_date.isoformat() }}_{{ booking.time_slot }}": {
                id: {{ booking.id }},
                name: "{{ booking.name }}",
                phone: "{{ booking.phone }}",
                booking_date: "{{ booking.booking_date.isoformat() }}",
                time_slot: "{{ booking.time_slot }}",
                booked_by: "{{ booking.user.username }}"
            },
        {% endfor %}
    };

    function setupBookingLinks() {
        console.log("Setting up booking links");
        document.querySelectorAll('.booking-link').forEach(link => {
            link.addEventListener('click', handleBookingLinkClick);
        });
    }

    function handleBookingLinkClick(event) {
        event.preventDefault();
        console.log("Booking link clicked");
        const cell = event.currentTarget.closest('.booking-cell');
        const booking_date = cell.getAttribute('data-date');
        const timeSlot = cell.getAttribute('data-time-slot');
        const bookingId = cell.getAttribute('data-booking-id');

        document.getElementById('booking_date').value = booking_date;
        document.getElementById('time_slot').value = timeSlot;
        document.getElementById('booking_id').value = bookingId;

        if (bookingId) {
            const selectedBooking = bookingsData[booking_date + '_' + timeSlot];
            if (selectedBooking) {
                document.getElementById('name').value = selectedBooking.name;
                document.getElementById('phone').value = selectedBooking.phone;
                document.getElementById('bookButton').textContent = 'Update Booking';
                document.getElementById('clearButton').style.display = 'inline-block';
            } else {
                console.error('Booking not found in bookingsData');
            }
        } else {
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('bookButton').textContent = 'Book';
            document.getElementById('clearButton').style.display = 'none';
        }
    }

    function setupClearButton() {
        const clearButton = document.getElementById('clearButton');
        if (clearButton) {
            clearButton.addEventListener('click', handleClearButtonClick);
        }
    }

    async function handleClearButtonClick() {
    const bookingId = document.getElementById('booking_id').value;
    if (bookingId) {
        try {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const response = await fetch(`/delete_booking/${bookingId}?start_date=${startDate}&end_date=${endDate}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const result = await response.json();
            if (response.ok && result.success) {
                updateBookingsData(result.bookingsData);
                updateBookingGrid();
                clearForm();
                alert(result.message);
            } else {
                alert(result.message || 'Failed to delete booking.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the booking.');
        }
    }
}

    function setupForm() {
        const form = document.getElementById('bookingForm');
        if (form) {
            form.addEventListener('submit', handleFormSubmit);
        }
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        const bookingId = document.getElementById('booking_id').value;
        const url = bookingId ? '/update_booking' : '/book';
        
        const formData = new FormData(event.target);
        
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                updateBookingsData(result.bookingsData);
                updateBookingGrid();
                clearForm();
                alert(result.message);
            } else {
                alert(result.message);
            }
        } else {
            alert('Failed to submit booking.');
        }
    }

    function updateBookingsData(newBookingData) {
        bookingsData = newBookingData;
    }

    function updateBookingGrid() {
        document.querySelectorAll('.booking-cell').forEach(cell => {
            const date = cell.getAttribute('data-date');
            const timeSlot = cell.getAttribute('data-time-slot');
            const key = `${date}_${timeSlot}`;
            const booking = bookingsData[key];
            const statusElement = cell.querySelector('.booking-status');
            const userElement = cell.querySelector('.booking-user');
            
            if (booking) {
                cell.classList.remove('open');
                cell.classList.add('booked');
                statusElement.textContent = 'Booked';
                userElement.textContent = `by ${booking.booked_by}`;
                cell.setAttribute('data-booking-id', booking.id);
            } else {
                cell.classList.remove('booked');
                cell.classList.add('open');
                statusElement.textContent = 'Open';
                userElement.textContent = '';
                cell.removeAttribute('data-booking-id');
            }
        });
    }

    function clearForm() {
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('booking_date').value = '';
        document.getElementById('time_slot').value = '';
        document.getElementById('booking_id').value = '';
        document.getElementById('bookButton').textContent = 'Book';
        document.getElementById('clearButton').style.display = 'none';
    }

    function setupDateRangeForm() {
        const form = document.getElementById('dateRangeForm');
        if (form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                window.location.href = `/bookings?start_date=${startDate}&end_date=${endDate}`;
            });
        }
    }

    function setupEventListeners() {
        setupBookingLinks();
        setupClearButton();
        setupForm();
        setupDateRangeForm();
    }

    // Initial setup
    setupEventListeners();
    updateBookingGrid();

</script>
{% endblock %}